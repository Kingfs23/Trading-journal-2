<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KìñgFX • History & Analytics</title>

  <!-- Optional: keep your existing global stylesheet if you want -->
  <!-- <link rel="stylesheet" href="style.css" /> -->

  <style>
    :root{
      --bg:#07060a;
      --panel:#12070a;
      --panel2:#18090d;
      --text:#f3f4f6;
      --muted:#a3a3a3;
      --line:rgba(255,0,0,.14);

      --good:#22c55e;
      --bad:#ef4444;
      --warn:#fbbf24;

      --shadow:0 12px 34px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1000px 650px at 18% -10%, rgba(255,0,0,.28), transparent 60%),
        radial-gradient(850px 520px at 105% 12%, rgba(140,0,0,.22), transparent 52%),
        radial-gradient(700px 420px at 55% 120%, rgba(255,40,40,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    /* Topbar */
    .topbar{
      position: sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px;
      border-bottom:1px solid var(--line);
      background: rgba(10, 6, 10, .78);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:40px; height:40px; border-radius:12px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, #ff1a1a, #7a0000);
      font-weight:800;
      box-shadow: var(--shadow);
    }
    .title{font-weight:800; letter-spacing:.2px}
    .subtitle{font-size:12px; color:var(--muted); margin-top:2px}
    .nav{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .navlink{
      padding:10px 12px;
      border-radius:12px;
      text-decoration:none;
      color:var(--text);
      border:1px solid transparent;
      background:transparent;
      font-weight:600;
      opacity:.9;
    }
    .navlink:hover{border-color:var(--line); background:rgba(255,255,255,.03)}
    .navlink.active{background:rgba(255,255,255,.06); border-color:var(--line)}
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn.primary{
      background: linear-gradient(135deg, #ff1a1a, #b30000);
      border:none;
    }
    .btn.primary:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* Layout */
    .container{max-width:1200px; margin: 18px auto; padding: 0 16px 40px}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }

    /* Panels / cards */
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 28%),
                  var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      display:flex; align-items:flex-end; justify-content:space-between;
      padding: 16px 16px 10px;
      border-bottom:1px solid var(--line);
    }
    .panelHeader h2{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted); font-size:12px}

    /* KPI */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 14px 16px 16px;
    }
    @media (max-width: 980px){
      .kpis{grid-template-columns: repeat(2, 1fr)}
    }
    @media (max-width: 480px){
      .kpis{grid-template-columns: 1fr}
    }
    .kpi{
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 35%),
                  var(--panel2);
      border:1px solid var(--line);
      border-radius: 16px;
    }
    .kpiLabel{color:var(--muted); font-size:12px; margin-bottom:6px}
    .kpiValue{font-size:22px; font-weight:900; letter-spacing:.2px}
    .kpiSub{margin-top:6px; font-size:12px; color:var(--muted)}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}

    /* Controls */
    .controls{
      display:flex; gap:10px; flex-wrap:wrap;
      padding: 14px 16px 16px;
      border-top:1px solid var(--line);
    }
    .control{
      display:flex; flex-direction:column;
      gap:6px;
      min-width: 160px;
      flex: 1 1 180px;
    }
    label{font-size:12px; color:var(--muted)}
    input, select{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(229,231,235,.5)}
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
      padding: 14px 16px 16px;
    }

    /* Trades list */
    .tradeList{padding: 14px 16px 18px; display:grid; gap:12px}
    .tradeCard{
      background: linear-gradient(180deg, rgba(255,255,255,.035), transparent 35%),
                  rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      transition: transform .18s ease, background .18s ease;
    }
    .tradeCard:hover{transform: translateY(-2px); background: rgba(255,255,255,.04)}
    .tradeTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .pair{
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.3px;
      line-height:1.2;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.15);
      font-size:12px;
      color: var(--text);
      font-weight: 800;
    }
    .chip.good{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}
    .chip.bad{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12)}
    .chip.warn{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.12)}
    .meta{margin-top:6px; font-size:12px; color:var(--muted)}
    .tradeInfo{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      font-size: 13px;
    }
    @media (max-width: 980px){
      .tradeInfo{grid-template-columns: repeat(3, 1fr)}
    }
    @media (max-width: 520px){
      .tradeInfo{grid-template-columns: repeat(2, 1fr)}
    }
    .field{
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .field b{display:block; font-size:11px; color:var(--muted); margin-bottom:6px}
    .field span{font-weight:800}
    .tradeImages{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .thumb{
      width: 210px;
      max-width: 100%;
      border-radius: 14px;
      border:1px solid var(--line);
      overflow:hidden;
      background: rgba(255,255,255,.02);
      cursor:pointer;
    }
    .thumb img{width:100%; height:100%; display:block}
    .thumbTitle{
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
      border-top: 1px solid var(--line);
    }

    /* Right column */
    .chartWrap{padding: 14px 16px 18px}
    canvas{width:100%; height:280px}
    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--line);
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
    }
    .table th{
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }
    .table tr:last-child td{border-bottom:none}
    .table td.num{text-align:right; font-variant-numeric: tabular-nums}

    /* Empty / loading */
    .state{
      padding: 18px 16px;
      color: var(--muted);
      font-size: 13px;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index:100;
    }
    .modal.show{display:flex}
    .modalPanel{
      width:min(980px, 100%);
      border-radius: 18px;
      background: var(--panel);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalTop{
      display:flex; justify-content:space-between; align-items:center;
      padding: 12px 14px;
      border-bottom:1px solid var(--line);
    }
    .modalTitle{font-weight:900}
    .modalBody{padding: 12px}
    #modalImg{width:100%; height:auto; border-radius: 14px; border:1px solid var(--line)}
  </style>
</head>
<body>

<header class="topbar">
  <div class="brand">
    <div class="logo">Kì</div>
    <div>
      <div class="title">History & Performance</div>
      <div class="subtitle">Win rate • Monthly breakdown • Trade cards (click images to preview)</div>
    </div>
  </div>

  <nav class="nav">
    <a class="navlink" href="index.html">Journal</a>
    <a class="navlink active" href="history.html">History</a>
    <button id="refreshBtn" class="btn">Refresh</button>
    <button id="exportBtn" class="btn primary">Export CSV</button>
  </nav>
</header>

<main class="container">
  <!-- Analytics Top -->
  <section class="panel">
    <div class="panelHeader">
      <div>
        <h2>Performance Analytics</h2>
        <div class="muted">Auto-calculated from your trades</div>
      </div>
      <div class="muted" id="lastUpdated">—</div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="kpiLabel">Total Trades</div>
        <div class="kpiValue" id="kpiTrades">—</div>
        <div class="kpiSub">Filtered view</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">Win Rate</div>
        <div class="kpiValue" id="kpiWinRate">—</div>
        <div class="kpiSub"><span class="good" id="kpiWins">—</span> wins • <span class="bad" id="kpiLosses">—</span> losses • <span class="warn" id="kpiBE">—</span> BE</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">Net Profit</div>
        <div class="kpiValue" id="kpiProfit">—</div>
        <div class="kpiSub">Sum of Profit column</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">Avg R (R-multiple)</div>
        <div class="kpiValue" id="kpiAvgR">—</div>
        <div class="kpiSub">Average of R column</div>
      </div>
    </div>

    <div class="controls">
      <div class="control">
        <label>Search (pair / notes)</label>
        <input id="searchInput" placeholder="e.g. EURUSD, London, sweep..." />
      </div>
      <div class="control">
        <label>Result</label>
        <select id="resultFilter">
          <option value="">All</option>
          <option value="win">Win</option>
          <option value="loss">Loss</option>
          <option value="be">BE</option>
        </select>
      </div>
      <div class="control">
        <label>Month</label>
        <select id="monthFilter">
          <option value="">All months</option>
        </select>
      </div>
      <div class="control">
        <label>Pair</label>
        <select id="pairFilter">
          <option value="">All pairs</option>
        </select>
      </div>
    </div>
  </section>

  <div style="height:16px"></div>

  <!-- Main grid -->
  <section class="grid">
    <!-- Left: Trades -->
    <section class="panel">
      <div class="panelHeader">
        <div>
          <h2>Trades</h2>
          <div class="muted" id="tradeCountLabel">—</div>
        </div>
        <div class="muted">Before / After</div>
      </div>
      <div id="historyContainer" class="tradeList">
        <div class="state">Loading trades…</div>
      </div>
    </section>

    <!-- Right: Monthly breakdown -->
    <aside class="panel">
      <div class="panelHeader">
        <div>
          <h2>Monthly Profit Breakdown</h2>
          <div class="muted">Profit & trade count per month</div>
        </div>
        <div class="muted" id="monthSummary">—</div>
      </div>

      <div class="chartWrap">
        <canvas id="monthlyChart"></canvas>
      </div>

      <div class="chartWrap" style="padding-top:0">
        <table class="table" id="monthlyTable">
          <thead>
            <tr>
              <th>Month</th>
              <th class="num">Trades</th>
              <th class="num">Wins</th>
              <th class="num">Win %</th>
              <th class="num">Profit</th>
              <th class="num">Avg R</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6" class="state">—</td></tr>
          </tbody>
        </table>
      </div>
    </aside>
  </section>
</main>

<!-- Modal preview -->
<div id="imgModal" class="modal">
  <div class="modalPanel">
    <div class="modalTop">
      <div class="modalTitle" id="modalTitle">Preview</div>
      <button id="closeModalBtn" class="btn">Close</button>
    </div>
    <div class="modalBody">
      <img id="modalImg" alt="Preview"/>
    </div>
  </div>
</div>

<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Your existing Supabase client setup (keep as-is in your project) -->
<script src="supabase.js"></script>

<!-- New history logic -->
<script src="history.js"></script>
</body>
</html>
